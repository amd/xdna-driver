# Maintainer: Your Name <your@email.com>
pkgname=xrt-plugin-amdxdna
pkgrel=1
pkgdesc="AMD XDNA Driver plugin for Xilinx RunTime"
arch=('x86_64')
url="https://github.com/amd/xdna-driver"
license=('Apache-2.0')
depends=('xrt-base' 'xrt-npu' 'dkms' 'linux-headers')
provides=('xrt-plugin-amdxdna')
conflicts=('amdxdna-driver' 'amdxdna-driver-bin')
install=xrt-plugin-amdxdna.install

# Set this to your xdna-driver build output directory (relative to $startdir, the PKGBUILD's directory)
: ${XDNA_BUILD_DIR:="../Release"}

# Extract version from the built tarball filename
_tarball=$(ls ${XDNA_BUILD_DIR}/xrt_plugin*-amdxdna.tar.gz 2>/dev/null | head -1)
pkgver=${_tarball#*xrt_plugin.}
pkgver=${pkgver%%_*}

package() {
  cd "$srcdir"

  # Extract the tarball directly into the package directory
  # Use nullglob to handle case where no files match the glob pattern
  local _nullglob_set=$(shopt -p nullglob)
  shopt -s nullglob
  local tarballs=("$startdir/${XDNA_BUILD_DIR}"/xrt_plugin*-amdxdna.tar.gz)
  $_nullglob_set
  if [ ${#tarballs[@]} -eq 0 ] || [ ! -f "${tarballs[0]}" ]; then
    error "XDNA plugin tarball not found in ${XDNA_BUILD_DIR}"
    error "Please build XDNA driver first: cd build && ./build.sh -release"
    return 1
  fi

  local tarball="${tarballs[0]}"
  msg2 "Extracting $tarball"
  tar -xzf "$tarball" -C "$pkgdir"

  # Copy the install scripts for reference (they'll be called from .install file)
  mkdir -p "$pkgdir/opt/xilinx/xrt/share/amdxdna/package"
  install -Dm755 "$startdir/${XDNA_BUILD_DIR}/package/postinst" \
    "$pkgdir/opt/xilinx/xrt/share/amdxdna/package/postinst"
  install -Dm755 "$startdir/${XDNA_BUILD_DIR}/package/prerm" \
    "$pkgdir/opt/xilinx/xrt/share/amdxdna/package/prerm"
}
